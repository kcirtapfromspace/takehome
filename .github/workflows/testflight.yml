name: Build & Deploy to TestFlight

on:
  push:
    branches: [main]
    paths:
      - 'ios/**'
      - 'bindings/**'
      - '.github/workflows/testflight.yml'
  workflow_dispatch:
    inputs:
      deploy_testflight:
        description: 'Deploy to TestFlight'
        required: false
        default: false
        type: boolean

env:
  SCHEME: TakeHome
  PROJECT_DIR: ios
  BUNDLE_ID: com.takehomepay.app

jobs:
  build:
    name: Build & Test
    runs-on: [self-hosted, macOS, ios-builder]
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ios

    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: |
          if ! command -v xcodegen &> /dev/null; then
            brew install xcodegen
          fi

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Build for testing
        run: |
          xcodebuild build \
            -project TakeHome.xcodeproj \
            -scheme $SCHEME \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
            -configuration Debug \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu) \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log

  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: [self-hosted, macOS, ios-builder]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && inputs.deploy_testflight)
    defaults:
      run:
        working-directory: ios

    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: |
          if ! command -v xcodegen &> /dev/null; then
            brew install xcodegen
          fi

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Setup Ruby
        run: |
          export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
          bundle install

      - name: Create App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p fastlane
          echo -n "$API_KEY_BASE64" | base64 --decode > fastlane/AuthKey.p8
          chmod 600 fastlane/AuthKey.p8

      - name: Install signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Install provisioning profile
        id: install-profile
        env:
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          PP_CONTENT=$(/usr/bin/security cms -D -i $PP_PATH)
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$PP_CONTENT")
          PP_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$PP_CONTENT")

          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

          echo "Installed provisioning profile: $PP_NAME (UUID: $PP_UUID)"
          echo "PP_UUID=$PP_UUID" >> $GITHUB_OUTPUT
          echo "PP_NAME=$PP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ./fastlane/AuthKey.p8
          APPLE_PROVISIONING_PROFILE_NAME: ${{ steps.install-profile.outputs.PP_NAME }}
          APPLE_PROVISIONING_PROFILE_UUID: ${{ steps.install-profile.outputs.PP_UUID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 5
        run: |
          export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
          bundle exec fastlane beta_manual \
            changelog:"Automated build from CI"

      - name: Clean up
        if: always()
        run: |
          rm -f fastlane/AuthKey.p8 || true
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
