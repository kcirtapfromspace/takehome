#!/bin/bash

# Pre-commit hook for TakeHome project
# Runs Rust formatting and linting checks

set -e

echo "Running pre-commit hooks..."

# Check if we're in the right directory or find the core directory
if [ -d "core" ]; then
    CORE_DIR="core"
elif [ -d "../core" ]; then
    CORE_DIR="../core"
else
    echo "Warning: Could not find core directory, skipping Rust checks"
    exit 0
fi

# Check if any Rust files are staged
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$RUST_FILES" ]; then
    echo "Checking Rust files..."

    # Run cargo fmt check
    echo "  Running cargo fmt --check..."
    cd "$CORE_DIR"
    if ! cargo fmt --check 2>/dev/null; then
        echo ""
        echo "ERROR: Rust formatting issues found!"
        echo "Run 'cargo fmt' in the core directory to fix formatting."
        echo ""
        exit 1
    fi
    echo "  ✓ Formatting OK"

    # Run cargo clippy
    echo "  Running cargo clippy..."
    if ! cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null; then
        echo ""
        echo "ERROR: Clippy found issues!"
        echo "Fix the warnings above before committing."
        echo ""
        exit 1
    fi
    echo "  ✓ Clippy OK"

    # Run tests
    echo "  Running cargo test..."
    if ! cargo test --quiet 2>/dev/null; then
        echo ""
        echo "ERROR: Tests failed!"
        echo "Fix failing tests before committing."
        echo ""
        exit 1
    fi
    echo "  ✓ Tests OK"

    cd - > /dev/null
fi

echo "All pre-commit checks passed!"
exit 0
